import numpy as np
import matplotlib.pyplot as plt
from scipy.integrate import odeint

# ---------- Константы ----------
g = 9.81
rho_0 = 1.225
G = 6.67430e-11
M_kerbin = 5.2915793e22
R_kerbin = 600_000
#A = 10.0
C_d = 2.0

stages = [
    {"wet_mass": 117_000, "fuel_mass": 101_000, "thrust": 2_816_500,
     "burn_time": 90, "ejection_force": 100, "area": 10.0},
    {"wet_mass": 63_800, "fuel_mass": 33_400, "thrust": 875_820,
     "burn_time": 47, "ejection_force": 100, "area": 8.0},
]

# ---------- Функции ----------
def air_density(h):
    return rho_0 * np.exp(-h / 4000)

def calculate_pitch(altitude):
    return 90 * (1 - altitude / 70000) if altitude < 70_000 else 0

def gravitational_acceleration(height):
    r = R_kerbin + height
    return G * M_kerbin / r ** 2

def rocket_equations(y, t, stage_index):
    x, vx, y_, vy = y
    stage = stages[stage_index]
    fuel_mass = stage["fuel_mass"]
    thrust = stage["thrust"]
    burn_time = stage["burn_time"]
    drain_speed = fuel_mass / burn_time
    ejection_force = stage["ejection_force"]
    area = stage["area"]

    cur_mass = start_mass - drain_speed * t
    vel2 = vx**2 + vy**2
    pitch = calculate_pitch(y_)

    # Силы
    gravity = cur_mass * gravitational_acceleration(y_)
    drag = 0.5 * C_d * air_density(y_) * vel2 * area
    radius = R_kerbin + y_
    centrifugal = cur_mass * vx**2 / radius

    a_vert = ((thrust - drag) * np.sin(np.radians(pitch)) + centrifugal - gravity) / cur_mass
    a_horiz = ((thrust - drag) * np.cos(np.radians(pitch))) / cur_mass

    # После окончания сжигания топлива
    if t >= burn_time - 7:
        a_horiz += (ejection_force / cur_mass) * np.cos(np.radians(pitch))
        a_vert   += (ejection_force / cur_mass) * np.sin(np.radians(pitch))
        print(a_horiz, a_vert, 'burn_time !!!')

    return [vx, a_horiz, vy, a_vert]

# ---------- Интегрирование ----------
# первая ступень
start_mass = 209_946                     # общая начальная масса
t1 = np.linspace(0, stages[0]["burn_time"], 1000)
res1 = odeint(rocket_equations, [0, 0, 0, 0], t1, args=(0,))

# вторая ступень (масса уже без топлива первой)
start_mass = stages[1]["wet_mass"]
t2 = np.linspace(0, stages[1]["burn_time"], 1000)
res2 = odeint(rocket_equations, res1[-1, :], t2, args=(1,))

# объединяем
time = np.concatenate([t1, t1[-1] + t2])
y_coords = np.concatenate([res1[:, 2], res2[:, 2]])
x_coords = np.concatenate([res1[:, 0], res2[:, 0]])
x_vel    = np.concatenate([res1[:, 1], res2[:, 1]])
y_vel    = np.concatenate([res1[:, 3], res2[:, 3]])
speed_coords = np.sqrt(x_vel**2 + y_vel**2)
Displacement_coords = np.sqrt(x_coords**2 + y_coords**2)

# ---------- Список требуемых времён ----------
raw_times = """
0
1,02
1,88
2,72
3,6
4,48
5,32
6,14
7,04
7,94
8,96
9,84
10,78
11,88
12,72
13,56
14,82
15,8
16,82
17,76
18,58
19,46
20,6
21,6
22,52
23,6
24,48
25,44
26,34
27,36
28,34
29,36
30,36
31,28
32,24
33,18
34,08
36,94
41,18
45,44
49,72
53,8
58,02
62,16
66,2
70,24
74,18
77,98
81,72
85,38
86,28
87,44
89,9
90,76
91,62
92,46
93,5
94,32
95,16
96,94
97,8
98,64
100,16
101,02
101,86
102,76
103,62
104,44
105,28
106,12
106,94
107,76
108,62
110,04
110,86
111,72
112,58
113,46
114,3
115,18
116,06
116,92
117,8
118,7
119,6
120,5
121,4
122,32
123,24
124,12
125,04
125,92
126,8
127,7
128,56
129,4
130,28
131,18
132,06
132,96
133,9
134,84
135,78
136,74
138,98
140,02
141
142,02
143,04
144,02
145,04
146,06
147,04
147,86
148,74
149,68
150,7
151,74
152,14
152,14
"""

# Приводим к типу float
query_times = np.array([float(s.replace(',', '.')) for s in raw_times.split()])

alt_norm_str = """
84.81056253868155
87.89628773729783
93.61358647851739
102.00932574586477
113.83166315488052
128.79922983713914
146.06519510538783
165.76663767860737
190.67599145683926
219.07325258117635
255.53610334498808
290.70011113071814
332.10698301298544
385.67635745659936
430.3478151652962
478.3195314115146
556.5442660935223
622.6523723914288
696.4176667721476
768.927262716461
835.7659010520438
911.2478079503635
1014.8658225241816
1111.237876862171
1204.469229475013
1319.5568416585447
1417.8796793832444
1529.843657057616
1639.3077614001231
1768.6809578151442
1898.353098581545
2038.9719002739294
2182.49420938245
2319.5389328823658
2467.711484470172
2617.968690329115
2766.6805350000504
3275.0628582288045
4116.91445189924
5080.578904487193
6174.712836256833
7338.5491996818455
8636.6115629751
9998.586787614971
11431.529230466229
12973.126446341397
14640.843974229647
16400.304687780794
18330.82469136361
20426.750901737367
20975.663617169484
21703.217352882377
23306.61283895606
23872.545098535018
24442.313225365127
25002.5545996991
25701.330557501642
26256.331184157985
26828.59410753206
28053.80779213528
28651.973081210395
29240.170772093697
30314.41309182858
30927.872691546218
31531.02397045947
32181.572598289116
32807.36616101221
33407.81712443812
34026.699555141386
34649.3886508249
35260.89685426233
35875.976556368754
36524.86221452989
37604.68656355026
38232.968386073015
38895.5774158251
39561.87669915403
40247.427245150204
40905.29124653409
41598.04501663905
42294.36148007121
42978.20948896883
43681.31009071693
44403.79597394075
45129.61980035959
45858.67467759736
46590.84351865912
47342.37970209122
48096.912502678926
48821.31833835004
49581.31704205484
50310.68550723069
51042.280057955184
51792.656279892195
52511.574409830966
53215.42537602456
53954.39513047831
54711.691930878325
55453.49006751343
56213.33458584244
57008.03159722919
57803.62585436262
58599.89089647599
59412.59096745285
61293.1292559834
62160.59260625334
62974.20416171162
63816.89565877372
64655.16723226034
65456.345790149644
66285.57367814053
67109.96390589862
67897.2453965611
68552.32159754052
69251.4598621478
69993.76534104801
70793.79041708249
71603.51247091568
71928.82357873942
71928.82357873942
"""
# переводим в массив float
alt_norm = np.array([float(s.replace(',', '.')) for s in alt_norm_str.split()])

# -------------------------------------------------
# Интерполяция
# -------------------------------------------------
alt_at_query = np.interp(query_times, time, y_coords, left=np.nan, right=np.nan)

Horizontal_Velocity_norm_str = """
0.016410856852527623
0.05496507750536121
0.09261446809222158
0.13099523935218713
0.1730524586153015
0.21666143420821998
0.2587180468654358
0.303557154328136
0.3538084987128756
0.40356047979120685
0.46180718481028155
0.5134670846708634
0.5691513812403622
0.6305509537847998
0.6807771036819623
0.7278413858997587
0.7970895378905875
0.8475578764868995
0.8959338447502653
0.9353728555272831
0.9689715296741825
1.0037692373925005
1.0535091314483962
1.1071146025850207
1.1712005854916863
1.2645818051786135
1.3661844430270946
1.5150717816821784
1.6917538048291902
1.9204034530998364
2.1991181357189253
2.547419650669431
2.9345874956573996
3.342661277003873
3.829015358696934
4.346890844196286
4.895036501014858
7.000325168909599
10.811394951652472
15.938871936583624
22.806980311722437
30.80498441002957
39.80955738944712
50.71251417418186
64.64163813003422
82.21391527059579
104.01830313070099
130.02458404982605
161.67996828142805
197.9124495871778
207.48388969098372
222.50203715029625
242.0657954860453
247.95739510744707
254.21825285632926
260.57411705342724
268.8002266463682
275.5288799830098
283.1782072514165
298.4864017448432
306.3471531259796
314.51404689983934
329.29724165152385
337.99489889081786
346.75653868497056
356.3678655965653
365.7776580338518
374.9539061678054
384.5608209876464
394.373110710592
404.1495831185763
414.12173966848394
425.04067286671346
442.8833079680131
453.52778975122675
464.947915529679
476.5794360667786
488.71432242036803
500.51310834943087
513.1032444971844
525.9253338703121
538.6770639383328
551.9541870968019
565.77165708185
579.8274662572151
594.1248805502164
608.6605724585427
623.7689284704846
639.1259001902292
654.0470186011296
669.8919677781219
685.2779604412806
700.8927414114692
717.0983561783391
732.8031141195455
748.3510959088132
764.8593684032479
781.9739818795282
798.9311071632471
816.5023286761071
835.0969939340022
853.9394051029714
873.0269600806081
881.134528375469
895.3247019588058
905.4866717518798
915.3372847496236
925.6098150974797
935.9950168342577
946.0295428884491
956.5632481198314
967.1636493818633
977.416134943555
986.0401000454442
995.34550388657
1005.332494309284
1016.2265611217915
1027.392293472355
1031.9173570602038
1031.9173570602038
"""
# переводим в массив float
Horizontal_Velocity_norm = np.array([float(s.replace(',', '.')) for s in Horizontal_Velocity_norm_str.split()])

# -------------------------------------------------
# Интерполяция
# -------------------------------------------------
Horizontal_Velocity_norm_query = np.interp(query_times, time, x_vel, left=np.nan, right=np.nan)

Total_Velocity_norm_str = """
1.1236143457776835
4.927820636943581
8.286154040669034
11.619241141275484
15.165118943420213
18.766696572546493
22.25471346535772
25.709751925254952
29.556832265556366
33.45972036709001
37.94927166409217
41.87829507720971
46.13116763078845
51.179934206235295
55.086696504697976
59.13156918763539
65.04236109309184
69.77789181626707
74.7653168070186
79.41326558238623
83.50766985661394
87.94182151164843
93.74742281230195
98.89607867797014
103.67830411467709
109.34706451704803
114.01121680862713
119.14696353355619
124.0078175575436
129.57192656096896
134.97676155339155
140.6664155447086
146.30775192256579
151.5562761087952
157.09379532270688
162.5791175068189
167.89109596490493
186.19227527163193
213.2146929153935
242.03170255061082
272.8828167460951
300.7828666729612
321.95253392339976
344.3796172012807
373.57815717019156
410.5273574351071
455.800978704263
508.17351898401233
568.9882776178911
633.7452168104182
651.2574290557728
676.2351426972803
699.0157690515724
705.2483420609541
711.636186293931
718.1867017228859
726.1544748922548
732.719392062231
740.5788886946046
754.6137411970403
762.1268896993931
770.1235147862366
783.4136740909905
791.4423922929614
799.397263787899
808.058025666302
816.4623132962969
824.5915509908999
833.0353881748174
841.5974972803438
850.0692766600137
858.6524074388797
868.2002957257537
883.0945466483514
892.117046346749
901.6791815578345
911.3611038478084
921.3862980663345
931.0691182300483
941.3298335938196
951.7109059753358
961.9742504041815
972.5960190958098
983.5849458695807
994.7028532122752
1005.9479480393726
1017.322398794864
1029.0812452723708
1040.9756950389753
1052.4805264030617
1064.6392842234302
1076.3982442723432
1088.280037255024
1100.5589098577516
1112.4146976375578
1124.1084849839167
1136.479776127527
1149.2604064236011
1161.8845896405915
1174.9236463933844
1188.6835651051954
1202.5851494069846
1216.6291543526813
1220.2811503286064
1224.7248503557503
1229.8971009923125
1234.4023956024491
1239.2988665756397
1244.1602238113903
1248.9138456151984
1253.855648401614
1258.84412378025
1263.6763198657795
1267.7544431261015
1272.1320544820856
1276.8502314616496
1282.0042350658805
1287.3847349166306
1289.6161778309486
1289.6161778309486
"""
# переводим в массив float
Total_Velocity_norm = np.array([float(s.replace(',', '.')) for s in Total_Velocity_norm_str.split()])

# -------------------------------------------------
# Интерполяция
# -------------------------------------------------
Total_Velocity_norm_query = np.interp(query_times, time, speed_coords, left=np.nan, right=np.nan)

Vertical_Velocity_norm_str = """
1.123494495676226
4.927514086244896
8.285636447853342
11.618502698126635
15.164131541722057
18.765445853188652
22.25320957519163
25.707959800657207
29.554714566723064
33.457286590263244
37.94646167904363
41.87514716543461
46.127656494614335
51.17604977769635
55.08248972528209
59.032503091538416
65.0374767717255
69.77274419118598
74.75994850051524
79.40775672489276
83.50204799318344
87.93609280667805
93.74150309472569
98.88988156093626
103.67168867769065
109.33975192652247
114.00303109238548
119.13733032413862
123.99627730076764
129.55769449669307
134.9588457229324
140.6433472131548
146.278318519408
151.51940946146993
157.04712404331187
162.52099553376073
167.81972089701094
185.44229784615695
212.28419731905177
240.80768697482637
271.18591352500596
298.50294848165345
319.1010795538685
340.1297063648203
367.30020934452386
401.4032419345331
442.78445300489795
490.0828149201059
544.1851586176766
602.0495512235574
617.3221804042316
637.39457493483
655.764588887254
660.2214432985753
664.6797285592859
669.0829827317532
674.5715377637182
678.9414877582262
683.5487174268522
693.071256348732
697.8458409809996
702.5803408101657
710.8447871324953
715.6399294632682
720.2748699148112
725.2308027199826
729.9434319975836
734.4118696038909
738.9593580927682
743.475754128532
747.8508471522646
752.1882354401272
756.6931455380554
764.0093938187981
768.2352297999712
772.5598891344364
776.8211523413656
781.096038477718
785.0963834409572
789.193839370424
793.1936659768503
797.0078288369971
800.8055892083455
804.5755264635654
808.2288509836674
811.7554437611216
815.1546912238041
818.4867337019682
821.6741941718183
824.5833832406761
827.4669522211346
830.0766815216662
832.527960205849
834.865175722168
836.938501597791
838.8030300761404
840.5810062764078
842.2091031545647
843.6141805654962
844.8488161326978
845.9205805946505
846.7576595381956
847.3549587943254
844.2085220796143
835.6701724611753
832.3104987376994
828.1949827282533
824.0801847459231
819.6633400218936
815.3612069209668
810.6421771503564
805.7809896556392
800.9591378725397
796.8225957942847
792.2166950611443
787.1804681707631
781.548741408641
775.7735049677692
773.4703965383476
773.4703965383476
"""
# переводим в массив float
Vertical_Velocity_norm = np.array([float(s.replace(',', '.')) for s in Vertical_Velocity_norm_str.split()])

# -------------------------------------------------
# Интерполяция
# -------------------------------------------------
Vertical_Velocity_norm_query = np.interp(query_times, time, y_vel, left=np.nan, right=np.nan)

Displacement_norm_str = """
0.2669050168031339
3.330184602403186
9.04782261214125
17.444078658026413
29.267165378053324
44.23570596967126
61.502818785928405
81.20560034413036
106.70971566947425
134.51599461369963
170.98150010988462
206.14810964518972
248.48268475754637
301.13148857030035
346.9100698940604
396.1491161983504
472.01220355248563
538.1251442673926
611.8956680983434
684.4101813095228
751.2531361514726
826.7396634416906
932.2406937047502
1026.7405234079474
1122.0521269780627
1235.068997446643
1333.3959030166436
1445.3644148654985
1554.8330314755021
1684.2119196914384
1813.8904704345414
1954.5176654220948
2098.050590471222
2238.141228847598
2383.2976629831965
2533.576655386508
2685.6747432331617
3228.0280026355604
4079.996462357586
5046.111573604977
6148.311993276954
7326.974971194321
8622.384266280933
9996.846520103747
11440.200562709799
13014.582579892152
14717.585468074969
16523.830763908794
18495.108732135064
20584.10758213555
21167.22751088077
22018.53190138045
23589.034346354318
24183.0255891417
24782.176021300074
25386.578279910183
26110.37293033365
26712.206352321762
27435.603877076548
28609.070842295794
29248.1767460803
29938.49367000776
31032.956231374108
31694.876741043514
32363.097798409035
33069.22006269469
33734.638102995275
34390.21075704543
35067.981036657206
35752.098935344904
36426.11302806693
37106.29687558056
37860.011410025414
39030.44977734547
39734.487805881115
40479.81474724791
41232.29692236707
42009.7461671644
42758.95500146726
43551.33038864143
44351.423990887444
45140.84222164327
45956.35799731367
46798.56042827024
47649.06209757681
48507.921227978724
49375.19103265778
50270.48485240422
51174.680491308456
52047.945598960585
52969.72242278366
53859.90379078212
54758.42706335637
55686.043953423636
56580.667652871336
57462.2945043173
58394.217488794035
59356.160200338825
60305.40752414117
61285.14885231936
62318.10543525433
63360.989756372845
64413.83981952479
65497.25428832856
68027.94671139063
69207.51048212637
70322.25242480348
71485.73620789676
72652.43913746698
73776.4568305701
74949.4152295949
76125.51080090072
77258.33931282318
78231.56448240008
79230.02895245755
80323.77223875154
81513.35591825996
82729.19846842413
83221.09652392927
83221.09652392927
"""
# переводим в массив float
Displacement_norm = np.array([float(s.replace(',', '.')) for s in Displacement_norm_str.split()])

# -------------------------------------------------
# Интерполяция
# -------------------------------------------------
Displacement_norm_query = np.interp(query_times, time, Displacement_coords, left=np.nan, right=np.nan)

# График высоты
plt.subplot(3, 2, 1)
plt.plot(query_times, alt_at_query, label="Высота (м)")
plt.plot(query_times, alt_norm, label='Высота (м) ksp', color='orange')
plt.title('Высота от времени')
plt.xlabel('Время (с)')
plt.ylabel('Высота (м)')
# 2) Ошибка
err = alt_norm - alt_at_query
mask = ~np.isnan(err)   # игнорируем NaN‑ы

plt.plot(query_times[mask], err[mask], label='Погрешность', color='tab:grey', linewidth=2)
plt.legend()

# График вертикальной скорости
plt.subplot(3, 2, 2)
plt.plot(query_times, Vertical_Velocity_norm_query, label='Скорость по вертикали', color='green')
plt.plot(query_times, Vertical_Velocity_norm, label='Скорость по вертикали ksp', color='red')
plt.title('Скорость по вертикали от времени')
plt.xlabel('Время (с)')
plt.ylabel('Скорость (м/с)')
# 2) Ошибка
err = Vertical_Velocity_norm - Vertical_Velocity_norm_query
mask = ~np.isnan(err)   # игнорируем NaN‑ы

plt.plot(query_times[mask], err[mask], label='Погрешность', color='tab:grey', linewidth=2)
plt.legend()

# График горизонтальной скорости
plt.subplot(3, 2, 3)
plt.plot(query_times, Horizontal_Velocity_norm_query, label='Скорость по горизонтали', color='blue')
plt.plot(query_times, Horizontal_Velocity_norm, label='Скорость по горизонтали ksp', color='orange')
plt.title('Скорость по горизонтали от времени')
plt.xlabel('Время (с)')
plt.ylabel('Скорость (м/с)')
# 2) Ошибка
err = Horizontal_Velocity_norm - Horizontal_Velocity_norm_query
mask = ~np.isnan(err)   # игнорируем NaN‑ы

plt.plot(query_times[mask], err[mask], label='Погрешность', color='tab:grey', linewidth=2)
plt.legend()

# График скорости
plt.subplot(3, 2, 4)
plt.plot(query_times, Total_Velocity_norm_query, label="Скорость (м/с)")
plt.plot(query_times, Total_Velocity_norm,label="Скорость (м/с) ksp", color='orange')
plt.title('Скорость от времени')
plt.xlabel('Время (с)')
plt.ylabel('Скорость (м/с)')
# 2) Ошибка
err = Total_Velocity_norm - Total_Velocity_norm_query
mask = ~np.isnan(err)   # игнорируем NaN‑ы

plt.plot(query_times[mask], err[mask], label='Погрешность', color='tab:grey', linewidth=2)
plt.legend()

# График смещения
plt.subplot(3, 2, 5)
plt.plot(query_times, Displacement_norm_query, label="Смещение")
plt.plot(query_times, Displacement_norm,label="Смещение ksp", color='orange')
plt.title('Смещение от времени')
plt.xlabel('Время (с)')
plt.ylabel('Смещение (м)')
# 2) Ошибка
err = Displacement_norm - Displacement_norm_query
mask = ~np.isnan(err)   # игнорируем NaN‑ы

plt.plot(query_times[mask], err[mask], label='Погрешность', color='tab:grey', linewidth=2)
plt.legend()

plt.tight_layout()
plt.show()